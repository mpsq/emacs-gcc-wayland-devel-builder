on:
  schedule:
    - cron: "0 4,10,16,22 * * *"

jobs:
  image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@master
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          builder: ${{ steps.buildx.outputs.name }}
          push: true
          tags: mpsq/emacs-native-comp-wayland-builder:latest

  artifact:
    runs-on: ubuntu-latest
    needs: [image]
    container:
      image: mpsq/emacs-native-comp-wayland-builder:latest
      options: --user root
    steps:
      - name: Prepare artifacts
        run: |
          pacman --noconfirm -S jq
          cd /home/pcr
          version=$(ls emacs* | sed -r 's/.*([0-9]{2}\.[0-9]{1,2}\.[0-9]{1,2}\.[0-9]{6}).*/\1/gi')
          release=$(curl "$GITHUB_API_URL"/repos/"$GITHUB_REPOSITORY"/releases/latest | jq .tag_name)
          # Check if a new release is needed
          [[ "$version" == "$release" ]] && exit 1
          # Let's build the artifacts then!
          echo "pkg_version=$version" >> $GITHUB_ENV
          mkdir pkg
          tar xf "$(ls emacs*)" -C pkg
          rm pkg/.BUILDINFO pkg/.MTREE pkg/.PKGINFO
          tar czf "$version".tar.gz -C pkg .
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.pkg_version }}
          release_name: Release ${{ env.pkg_version }}
          body: Check emacs git repository.
          draft: false
          prerelease: false
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /home/pcr/${{ env.pkg_version }}.tar.gz
          asset_name: ${{ env.pkg_version }}.tar.gz
          asset_content_type: application/gzip
